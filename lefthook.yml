# OpenTile Mobile - Git Hooks Configuration
# See: https://github.com/evilmartians/lefthook/blob/master/docs/configuration.md

# Minimum lefthook version
min_version: 1.9.2

# Output options
output:
  - summary
  - success

# Skip hooks on merge commits
skip_output:
  - meta
  - execution

# Pre-commit hook: Run before committing
pre-commit:
  parallel: true
  commands:
    # 1. Kotlin linting with ktlint
    ktlint:
      glob: "*.{kt,kts}"
      run: ./gradlew ktlintCheck --daemon
      stage_fixed: true
      fail_text: "❌ ktlint failed. Run './gradlew ktlintFormat' to fix."

    # 2. Static analysis with detekt
    detekt:
      glob: "*.{kt,kts}"
      run: ./gradlew detekt --daemon
      fail_text: "❌ Detekt found issues. Check build/reports/detekt/"

    # 3. Unit tests (shared module only - fast)
    test-shared:
      glob: "shared/**/*.kt"
      run: ./gradlew :shared:testDebugUnitTest --daemon
      fail_text: "❌ Shared tests failed. Fix before committing."

    # 4. Check for TODO/FIXME in staged files
    check-todos:
      glob: "*.{kt,kts}"
      run: |
        if git diff --cached --name-only | xargs grep -n "TODO\|FIXME" 2>/dev/null; then
          echo "⚠️  Warning: TODOs/FIXMEs found in staged files"
          echo "Consider resolving before committing"
          exit 0  # Don't fail, just warn
        fi

# Pre-push hook: Run before pushing to remote
pre-push:
  parallel: false  # Run sequentially
  commands:
    # 1. Full test suite (slower, but comprehensive)
    test-all:
      run: ./gradlew test --daemon
      fail_text: "❌ Tests failed. Fix before pushing."

    # 2. Build check (ensure project compiles)
    build-check:
      run: ./gradlew assembleDebug --daemon
      fail_text: "❌ Build failed. Fix compilation errors before pushing."

# Commit message linting (optional)
commit-msg:
  commands:
    conventional-commits:
      run: |
        # Check commit message follows conventional commits format
        # Example: "feat(drawing): add smart snapping"
        MSG_FILE=$1
        MSG=$(cat "$MSG_FILE")
        PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .{1,50}"

        if ! echo "$MSG" | grep -qE "$PATTERN"; then
          echo "❌ Commit message must follow Conventional Commits format:"
          echo "   <type>(<scope>): <subject>"
          echo ""
          echo "Types: feat, fix, docs, style, refactor, test, chore, perf"
          echo "Example: feat(drawing): add smart snapping"
          exit 1
        fi

# Skip hooks for certain scenarios
skip_ref:
  - main      # Don't run hooks on main branch (CI handles it)
  - master    # Don't run hooks on master branch
  - develop   # Don't run hooks on develop branch
